<% layout('./Layout/layout.ejs') -%>

    <div id="content" class="app-content">



        <div class="d-flex align-items-center mb-md-3 mb-2">
            <div class="flex-fill">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="/faculty/class">MANAGE CLASSES</a></li>
                    <li class="breadcrumb-item active">VIEW CLASS</li>
                </ol>
                <h1 class="page-header">
                    View Classes <small>overview &amp; actions</small>
                </h1>
            </div>
            <div class="ms-auto">

                <button type="button" class="btn btn-theme" data-bs-toggle="modal" data-bs-target="#addUser">
                    <i class="fa fa-plus-circle me-1"></i> Add Student
                </button>
            </div>
        </div>



        <div class="row">
            <div class="col-lg-12">
                <div class="card">
                    <div class="card-body">
                        <p class="mb-0"><strong>Class Name:</strong>
                            <%= class_info.class_name %>
                        </p>
                        <p class="mb-0"><strong>Room Number:</strong>
                            <%= class_info.room_number %>
                        </p>

                        <p class="mb-0"><strong>Subject Name:</strong>
                            <%= class_info.subject_name %>
                        </p>
                        <ul class="nav nav-tabs nav-tabs-v2  " role="tablist">
                            <li class="nav-item me-3 " role="presentation"><a href="#enrolledStudent"
                                    class="nav-link px-2 active" data-bs-toggle="tab" aria-selected="true"
                                    role="tab">Enrolled students</a></li>
                            <li class="nav-item me-3" role="presentation"><a href="#attendanceClassTable" class="nav-link px-2 "
                                    data-bs-toggle="tab" aria-selected="false" role="tab" tabindex="-1">Attendance Class</a>
                            </li>

                        </ul>
                        <div class="tab-content">
                            <div class="tab-pane fade active show" id="enrolledStudent" role="tabpanel">
                                <h4 class="mt-3"></h4>
                                <div class="table-responsive">
                                    <table class="table table-bordered" id="classTable" style="width: 100%;">
                                        <thead>
                                            <tr>
                                                <th>#</th>
                                                <th>Student Number</th>
                                                <th>Name</th>
                                                <th>Degree</th>
                                                <th>Year & Section</th>
                                                <th>Action</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <% student_class.forEach((student, index)=> { %>
                                                <tr>
                                                    <td>
                                                        <%= index + 1 %>
                                                    </td>
                                                    <td>
                                                        <%= student.student_id %>
                                                    </td>
                                                    <td>
                                                        <%= student.name %>
                                                    </td>
                                                    <td>
                                                        <%= student.degree %>
                                                    </td>
                                                    <td>
                                                        <%= student.year_section %>
                                                    </td>
                                                    <td class="text-center">
                                                        <div class="btn-group">

                                                            <button type="button"
                                                                onclick="deleteById('<%= student.student_id %>','          <%= student.name %>')"
                                                                class="btn btn-default"><i
                                                                    class="fas fa-fw fa-trash-alt"></i></button>

                                                        </div>
                                                    </td>
                                                </tr>
                                                <% }) %>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            <div class="tab-pane fade " id="attendanceClassTable" role="tabpanel">
                                <h4 class="mt-3"></h4>
                                <div class="table-responsive">
                                    <table class="table table-bordered" id="viewAttendanceTable" style="width: 100%;">
                                        <thead>
                                            <tr>
                                                <th>#</th>
                                                <th>Student Number</th>
                                                <th>Name</th>
                                            
                                                <th>Attendance Date</th>
                                                <th>Status</th>
                                                <th>Logs</th>
                                          
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <% student_attendance.forEach((student, index) => { %>
                                                <tr>
                                                    <td>
                                                        <%= index + 1 %>
                                                    </td>
                                                    <td>
                                                        <%= student.student_id %>
                                                    </td>
                                                    <td>
                                                        <%= student.name %>
                                                    </td>
                                                  
                                                    <td>
                                                        <%= student.log_date ? new Date(student.log_date).toLocaleDateString('en-US', {
                                                            year: 'numeric',
                                                            month: 'long',
                                                            day: 'numeric'
                                                        }) : 'N/A' %> <!-- Attendance date -->
                                                    </td>
                                                    
                                                    <td>
                                                        <span class="<%= student.status === 'Present' ? 'text-success' : student.status === 'Absent' ? 'text-danger' : '' %>">
                                                            <%= student.status || 'N/A' %>
                                                        </span> <!-- Attendance status -->
                                                    </td>
                                                    <td>
                                                        <%= student.logs || 'N/A' %> <!-- Attendance logs -->
                                                    </td>
                                                  
                                                </tr>
                                            <% }) %>
                                        </tbody>
                                    </table>
                                </div>
                                
                            </div>
                        </div>

                    </div>
                </div>
            </div>
        </div>
        <!-- Modal -->
        <div class="modal fade" id="addUser" tabindex="-1" aria-labelledby="addUser" aria-hidden="true">
            <div class="modal-dialog ">

                <form class="add-class-student-validation" method="POST">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h1 class="modal-title fs-5" id="addUser">Add New Student</h1>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <div class="row">


                                <div class="mb-2">
                                    <label for="student_id" class="form-label">Student ID</label>
                                    <input type="hidden" name="class_id" id="class_id"
                                        value="<%= class_info.class_id %>">
                                    <input class="form-control" type="text" name="student_id" id="student_id" required>
                                    <div id="error-upload-message" class="mt-2"></div>
                                </div>




                            </div>
                        </div>

                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                            <button type="submit" class="btn btn-primary" id="submit-button">Insert
                                <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"
                                    style="display: none;"></span>
                            </button>
                        </div>
                    </div>

                </form>
            </div>
        </div>
        <div class="modal fade" id="modal-delete" tabindex="-1" aria-labelledby="modal-delete" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <form id="deleteForm" action="/faculty/class/remove/" method="POST">
                        <input type="hidden" name="id" id="delete-id">
                        <div class="modal-header">
                            <h5 class="modal-title">Delete Student</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <p>Are you sure you want to remove <span id="delete_name" class="fw-bold"></span> from the
                                class
                                ?</p>
                            <div class="alert alert-danger d-flex align-items-center" role="alert">
                                <i class="fa fa-exclamation-triangle me-2"></i>
                                <div>
                                    <strong>Note:</strong> Deleting this will also delete all attendance records.
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                            <button type="submit" class="btn btn-danger">Delete</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
    <script>
        function deleteById(name, id) {
            document.getElementById("delete_name").innerText = id;
            document.getElementById("delete-id").value = name;

            // Show the modal using Bootstrap 5 API
            const modal = new bootstrap.Modal(
                document.getElementById("modal-delete")
            );
            modal.show();
        }

        document
            .getElementById("deleteForm")
            .addEventListener("submit", async function (event) {
                event.preventDefault(); // Prevent the form from submitting the traditional way

                const id = document.getElementById(
                    "delete-id"
                ).value;


                try {
                    const response = await fetch("/faculty/class/remove", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                        },
                        body: JSON.stringify({ student_id: id, class_id: <%= class_info.class_id %> }),
                    });

                    const result = await response.json();

                    if (result.success) {
                        // Close the modal
                        const modal = bootstrap.Modal.getInstance(
                            document.getElementById("modal-delete")
                        );
                        modal.hide();

                        $.notify(
                            {
                                icon: "fa fa-check me-1",
                                message: "Student removed successfully!",
                            },
                            {
                                type: "success",
                                allow_dismiss: false,
                            }
                        );
                        setTimeout(() => {
                            window.location.reload();
                        }, 2000);
                    } else {
                        $.notify(
                            {
                                icon: "fa fa-check me-1",
                                message: "There was an error!",
                            },
                            {
                                type: "danger",
                                allow_dismiss: false,
                            }
                        );
                        setTimeout(() => {
                            window.location.reload();
                        }, 2000);
                    }
                } catch (error) {
                    $.notify(
                        {
                            icon: "fa fa-times-circle me-1",
                            message: "An error occurred. Please try again.",
                        },
                        {
                            type: "danger",
                        }
                    );
                    console.error("Error:", error);
                }
            });
    </script>
    <script>

        var table = $("#classTable").DataTable({
            processing: true,


        });
    </script>
    <script>
        !(function () {
            "use strict";
            class e {
                static initValidation() {
                    // Initialize jQuery validation
                    jQuery(".add-class-student-validation").validate({
                        rules: {
                            student_id: {
                                required: true,
                                minlength: 9,

                            },

                        },
                        messages: {
                            student_id: {
                                required: "Please enter the student number",
                                minlength:
                                    "The student number must consist of at least 9 characters",

                            },


                            // Other messages
                        },
                        submitHandler: function (form, event) {
                            const errorMessageDiv = document.getElementById("error-upload-message");
                            const submitButton =
                                document.getElementById("submit-button");
                            const spinner =
                                submitButton.querySelector(".spinner-border");
                            // Show spinner and disable button
                            spinner.style.display = "inline-block";
                            submitButton.disabled = true;
                            submitButton.innerHTML =
                                '<span class="spinner-border spinner-border-sm me-1" role="status" aria-hidden="true"></span>Inserting...';
                            const formData = new FormData(form); // Collect form data

                            fetch("/faculty/class/enroll", {
                                method: "POST",
                                body: formData,
                            })
                                .then((response) => response.json())
                                .then((data) => {
                                    spinner.style.display = "none";
                                    submitButton.disabled = false;
                                    submitButton.innerHTML =
                                        '<span class="spinner-border spinner-border-sm me-1" role="status" aria-hidden="true" style="display: none;"></span>Insert';
                                    if (data.success) {

                                        const modal =
                                            document.querySelector("#addUser"); // Replace with your modal's ID
                                        if (modal) {
                                            const modalInstance =
                                                bootstrap.Modal.getInstance(modal); // Bootstrap 5
                                            if (modalInstance) {
                                                modalInstance.hide(); // Close the modal
                                            }
                                        }
                                        $.notify(
                                            {
                                                type: "success",
                                                icon: "fa fa-check me-1",
                                                message: data.message,
                                            },
                                            {
                                                type: "success",
                                                allow_dismiss: false,
                                            }
                                        );
                                        // Reset the form
                                        form.reset();
                                        setTimeout(() => {
                                            window.location.reload();
                                        }, 2000);

                                    } else {
                                        errorMessageDiv.innerHTML = `<div class="alert alert-danger">${data.message}</div>`;
                                    }
                                })
                                .catch((error) => {
                                    spinner.style.display = "none";
                                    submitButton.disabled = false;
                                    submitButton.innerHTML =
                                        '<span class="spinner-border spinner-border-sm me-1" role="status" aria-hidden="true" style="display: none;"></span>Insert';
                                    $.notify(
                                        {
                                            type: "danger",
                                            icon: "fa fa-times-circle me-1",
                                            message:
                                                "An error occurred. Please try again.",
                                        },
                                        {
                                            type: "danger",
                                            allow_dismiss: false,
                                        }
                                    );
                                    console.error("Error:", error);
                                });
                        },
                    });
                }

                static init() {
                    this.initValidation();
                }
            }

            // Call init function on document ready
            $(document).ready(() => e.init());
        })();

        var table = $("#viewAttendanceTable").DataTable({
        dom: 'Bfrtip', // Specify the placement of the buttons
        buttons: [
            'copy', 
            {
                extend: 'excel',
                text: 'Download Excel',
                title: 'Attendance Data for Class <%= class_info.class_name %>' // Set title for the Excel file
            },
            {
                extend: 'pdf',
                text: 'Download PDF',
                title: 'Attendance Data', // Set title for the PDF file
                orientation: 'portrait',
                pageSize: 'A4'
            },
            'print' // Optionally add a print button
        ],
    })

    </script>